---
import Analytics from '../components/Analytics.astro';
import Meta from '../components/Meta.astro';
import { canonicalFor } from '../lib/siteConfig';
import '../styles/global.css';

interface Props {
  description?: string;
  canonical?: string;
  noindex?: boolean;
  pageTitle?: string;
}
const { description = 'Professional psychological services.', canonical, noindex = false, pageTitle } = Astro.props as Props;
const pathname = Astro.url.pathname;
const base = import.meta.env.BASE_URL.replace(/\/$/, '');
const computedCanonical = canonical || canonicalFor(pathname);
---
<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&subset=cyrillic,latin&display=swap" rel="stylesheet" />
    <Meta pageTitle={pageTitle} description={description} canonical={computedCanonical} noindex={noindex} />
    <Analytics />
    <slot name="head" />
  </head>
  <body>
    <a href="#main" class="skip-link">Skip to content</a>

    <header class="site-header" role="banner">
      <div class="header-inner">
        <div class="logo">
          <a href={base + '/'} aria-label="Главная">
            <img src={base + '/images/ducksandhorses.jpg'} alt="" width="36" height="36" loading="lazy" decoding="async" />
            <span>Анна Лопатина</span>
          </a>
        </div>

        <nav aria-label="Основная навигация">
          <ul class="nav-desktop">
            <li><a href={base + '/'}>Главная</a></li>
            <li><a href="#about">Обо мне</a></li>
            <li><a href="#pricing">Формат</a></li>
            <li><a href="#faq">Вопросы</a></li>
          </ul>
        </nav>

        <div class="header-actions">
          <button type="button" id="theme-toggle" aria-label="Переключить тему" class="theme-icon-btn">
            <svg data-icon-sun xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
            <svg data-icon-moon xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" style="display:none;"><path d="M21 12.79A9 9 0 0 1 11.21 3 7 7 0 0 0 12 21a9 9 0 0 1 9-8.21Z"/></svg>
          </button>
          <a href="https://t.me/ducksandhorses" target="_blank" rel="noopener" class="btn-cta header-cta-desktop">Записаться +</a>
          <button type="button" class="hamburger" id="hamburger-btn" aria-label="Открыть меню" aria-expanded="false" aria-controls="mobile-menu">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
          </button>
        </div>
      </div>
    </header>

    <!-- Mobile menu overlay -->
    <div class="mobile-menu" id="mobile-menu" aria-hidden="true">
      <div class="mobile-menu-panel">
        <button type="button" class="mobile-menu-close" id="mobile-menu-close" aria-label="Закрыть меню">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
        <nav aria-label="Мобильная навигация">
          <ul class="mobile-nav">
            <li><a href={base + '/'}>Главная</a></li>
            <li><a href="#about">Обо мне</a></li>
            <li><a href="#pricing">Формат</a></li>
            <li><a href="#faq">Вопросы</a></li>
          </ul>
        </nav>
        <div class="mobile-menu-cta">
          <a href="https://t.me/ducksandhorses" target="_blank" rel="noopener" class="btn-cta">Записаться +</a>
        </div>
      </div>
    </div>

    <main id="main">
      <slot />
    </main>

    <footer class="site-footer">
      <div class="footer-grid">
        <div class="footer-brand">
          <h3>Анна Лопатина — Психолог</h3>
          <p>Психологическая поддержка онлайн. Помогаю разобраться в себе, когда тревога, стресс и подавленность мешают ясно жить и действовать.</p>
        </div>
        <div class="footer-nav">
          <h4>Навигация</h4>
          <ul>
            <li><a href={base + '/'}>Главная</a></li>
            <li><a href={base + '/schedule'}>Запись</a></li>
            <li><a href={base + '/privacy'}>Конфиденциальность</a></li>
            <li><a href={base + '/emergency'}>Экстренная помощь</a></li>
          </ul>
        </div>
      </div>
      <div class="footer-bottom">
        <p>&copy; {new Date().getFullYear()} Анна Лопатина. Все права защищены.</p>
        <p>Сайт не предоставляет экстренную психиатрическую помощь.</p>
      </div>
    </footer>

    <!-- Mobile menu script -->
    <script is:inline>
      (function(){
        var hamburger = document.getElementById('hamburger-btn');
        var menu = document.getElementById('mobile-menu');
        var closeBtn = document.getElementById('mobile-menu-close');
        if (!hamburger || !menu) return;

        function openMenu() {
          menu.classList.add('open');
          menu.setAttribute('aria-hidden', 'false');
          hamburger.setAttribute('aria-expanded', 'true');
          document.body.style.overflow = 'hidden';
        }
        function closeMenu() {
          menu.classList.remove('open');
          menu.setAttribute('aria-hidden', 'true');
          hamburger.setAttribute('aria-expanded', 'false');
          document.body.style.overflow = '';
        }

        hamburger.addEventListener('click', openMenu);
        if (closeBtn) closeBtn.addEventListener('click', closeMenu);

        // Close on backdrop click
        menu.addEventListener('click', function(e) {
          if (e.target === menu) closeMenu();
        });

        // Close on Escape
        document.addEventListener('keydown', function(e) {
          if (e.key === 'Escape' && menu.classList.contains('open')) closeMenu();
        });

        // Close on anchor click (smooth scroll)
        menu.querySelectorAll('a').forEach(function(link) {
          link.addEventListener('click', closeMenu);
        });
      })();
    </script>

    <!-- Theme toggle -->
    <script is:inline>
      (function(){
        var root = document.documentElement;
        root.classList.add('js');
        var pref = localStorage.getItem('theme');
        if (pref === 'dark' || pref === 'light') {
          root.setAttribute('data-theme', pref);
        } else {
          // Always set data-theme so [data-theme] CSS selectors apply consistently
          root.setAttribute('data-theme', matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
        }
        var btn = document.getElementById('theme-toggle');
        if (!btn) return;
        var sun = btn.querySelector('[data-icon-sun]');
        var moon = btn.querySelector('[data-icon-moon]');
        var reducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
        var animTimer = null;
        function current(){
          var attr = root.getAttribute('data-theme');
          if (attr) return attr;
          return matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
        }
        function render(){
          var mode = current();
          if (sun && moon) {
            if (mode === 'dark') {
              sun.style.display = 'none';
              moon.style.display = '';
              btn.setAttribute('aria-label', 'Включить светлую тему');
            } else {
              sun.style.display = '';
              moon.style.display = 'none';
              btn.setAttribute('aria-label', 'Включить тёмную тему');
            }
          }
        }
        btn.addEventListener('click', function() {
          var mode = current();
          var next = mode === 'dark' ? 'light' : 'dark';
          if (!reducedMotion) {
            root.classList.add('theme-animating');
            if (animTimer) clearTimeout(animTimer);
          }
          root.setAttribute('data-theme', next);
          localStorage.setItem('theme', next);
          render();
          if (!reducedMotion) {
            animTimer = setTimeout(function(){ root.classList.remove('theme-animating'); }, 300);
          }
        });
        render();
      })();
    </script>
  </body>
</html>
