---
import Layout from '../../layouts/Layout.astro';
const base = import.meta.env.BASE_URL.replace(/\/$/, '');
---
<Layout title="Schedule" description="Book a first meeting or a regular therapy session." canonical={base + '/schedule/'}>
  <h1>Schedule</h1>
  <p style="max-width:60ch;">Use the links below to open a scheduling popup. If the popup does not open, right‑click the link and open in a new tab. Not for emergencies—if you are in crisis, visit the <a href={base + '/emergency'}>Emergency & Crisis Resources</a> page instead.</p>
  <section aria-labelledby="first-meeting-heading" style="margin-top:var(--space-8);">
    <h2 id="first-meeting-heading">Book a First Meeting</h2>
    <p class="muted" style="font-size:var(--font-size-sm);margin-top:0;">30 minute introductory session.</p>
  <p><a class="schedule-link" href="https://calendly.com/masachusec1/30min" data-calendly-base="https://calendly.com/masachusec1/30min">Open first meeting scheduler</a></p>
    <noscript><p>JavaScript disabled. Book directly at <a href="https://calendly.com/masachusec1/30min" rel="nofollow noopener">Calendly 30min</a>.</p></noscript>
  </section>
  <section aria-labelledby="regular-session-heading" style="margin-top:var(--space-9);">
    <h2 id="regular-session-heading">Book a Regular Session</h2>
    <p class="muted" style="font-size:var(--font-size-sm);margin-top:0;">Standard follow-up session.</p>
  <p><a class="schedule-link" href="https://calendly.com/masachusec1/clone" data-calendly-base="https://calendly.com/masachusec1/clone">Open regular session scheduler</a></p>
    <noscript><p>JavaScript disabled. Book directly at <a href="https://calendly.com/masachusec1/clone" rel="nofollow noopener">Calendly regular session</a>.</p></noscript>
  </section>
  <link href="https://assets.calendly.com/assets/external/widget.css" rel="stylesheet" />
  <script type="text/javascript" src="https://assets.calendly.com/assets/external/widget.js" async></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const paramsBase = 'hide_event_type_details=1&hide_gdpr_banner=1';
      function themeParams(){
        // Determine current theme (same logic as layout)
        const root = document.documentElement;
        const attr = root.getAttribute('data-theme');
        let mode = attr || (matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
        // Define palette per mode
        if(mode === 'dark') {
          return 'background_color=0f172a&text_color=f1f5f9&primary_color=0F766E';
        } else {
          return 'background_color=f1f5f9&text_color=0f172a&primary_color=0F766E';
        }
      }
      function buildUrl(base){
        return base + (base.includes('?') ? '&' : '?') + paramsBase + '&' + themeParams();
      }
      function openPopup(url){
        if(window.Calendly){
          window.Calendly.initPopupWidget({ url });
        } else {
          window.location.href = url; // fallback
        }
      }
      function bind(el){
        el.addEventListener('click', e => {
          e.preventDefault();
            const base = el.getAttribute('data-calendly-base') || el.href;
            openPopup(buildUrl(base));
        });
      }
      document.querySelectorAll('[data-calendly-base]').forEach(bind);
      // Optional: re-bind when theme toggle changes if custom event emitted (not implemented here)
    });
  </script>
</Layout>
