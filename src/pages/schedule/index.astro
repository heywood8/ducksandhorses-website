---
import Layout from '../../layouts/Layout.astro';
const base = import.meta.env.BASE_URL.replace(/\/$/, '');
---
<Layout title="Запись" description="Записаться на первую встречу или регулярную терапевтическую сессию." canonical={base + '/schedule/'}>
  <h1>Запись</h1>
  <p>Вы можете выбрать подходящее время с помощью ссылок ниже. Откроется защищённое всплывающее окно Calendly. Этот сайт не сохраняет ваши данные.</p>
  <section aria-labelledby="first-meeting-heading" style="margin-top:var(--space-8);">
    <h2 id="first-meeting-heading">Первая встреча</h2>
    <p class="muted" style="font-size:var(--font-size-sm);margin-top:0;">30‑минутная вводная беседа.</p>
    <p><a class="schedule-link" href="https://calendly.com/masachusec1/30min" data-calendly-base="https://calendly.com/masachusec1/30min">Открыть окно записи (первая встреча)</a></p>
    <noscript><p>JavaScript отключён. Можно записаться напрямую: <a href="https://calendly.com/masachusec1/30min" rel="nofollow noopener">Calendly 30min</a>.</p></noscript>
  </section>
  <section aria-labelledby="regular-session-heading" style="margin-top:var(--space-9);">
    <h2 id="regular-session-heading">Регулярная сессия</h2>
    <p class="muted" style="font-size:var(--font-size-sm);margin-top:0;">Стандартная последующая встреча.</p>
    <p><a class="schedule-link" href="https://calendly.com/masachusec1/clone" data-calendly-base="https://calendly.com/masachusec1/clone">Открыть окно записи (сессия)</a></p>
    <noscript><p>JavaScript отключён. Можно записаться напрямую: <a href="https://calendly.com/masachusec1/clone" rel="nofollow noopener">Calendly regular session</a>.</p></noscript>
  </section>
  <link href="https://assets.calendly.com/assets/external/widget.css" rel="stylesheet" />
  <script type="text/javascript" src="https://assets.calendly.com/assets/external/widget.js" async></script>
  <style>
    /* Lower Calendly popup a bit on small screens so close button doesn't clash with theme toggle */
    @media (max-width: 640px) {
      #calendlyOverlay { padding-top: 56px !important; }
    }
  </style>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const paramsBase = 'hide_event_type_details=1&hide_gdpr_banner=1';
      function themeParams(){
        // Determine current theme (same logic as layout)
        const root = document.documentElement;
        const attr = root.getAttribute('data-theme');
        let mode = attr || (matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
        // Define palette per mode
        if(mode === 'dark') {
          return 'background_color=0f172a&text_color=f1f5f9&primary_color=0F766E';
        } else {
          return 'background_color=f1f5f9&text_color=0f172a&primary_color=0F766E';
        }
      }
      function buildUrl(base){
        return base + (base.includes('?') ? '&' : '?') + paramsBase + '&' + themeParams();
      }
      function openPopup(url){
        if(window.Calendly){
          window.Calendly.initPopupWidget({ url });
          // Attempt to adjust overlay shortly after open (mobile only)
          setTimeout(() => {
            if (window.innerWidth < 640) {
              const overlay = document.getElementById('calendlyOverlay');
              if (overlay) overlay.style.paddingTop = '56px';
            }
          }, 150);
        } else {
          window.location.href = url; // fallback
        }
      }
      function bind(el){
        el.addEventListener('click', e => {
          e.preventDefault();
            const base = el.getAttribute('data-calendly-base') || el.href;
            openPopup(buildUrl(base));
        });
      }
      document.querySelectorAll('[data-calendly-base]').forEach(bind);
      // Optional: re-bind when theme toggle changes if custom event emitted (not implemented here)
    });
  </script>
</Layout>
