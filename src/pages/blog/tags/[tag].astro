---
import { getCollection } from 'astro:content';

import Layout from '../../../layouts/Layout.astro';

const tag = Astro.params.tag?.toLowerCase() || '';
const all = await getCollection('blog');
const posts = all.filter(p => !p.data.draft && p.data.tags.map(t => t.toLowerCase()).includes(tag))
  .sort((a,b) => b.data.publishDate.getTime() - a.data.publishDate.getTime());
export async function getStaticPaths() {
  const entries = await getCollection('blog');
  const tagSet = new Set<string>();
  for (const e of entries) {
    if (e.data.draft) continue;
    for (const t of e.data.tags) tagSet.add(t.toLowerCase());
  }
  return Array.from(tagSet).map(t => ({ params: { tag: t } }));
}
---
<Layout title={`Tag: ${tag}`} description={`Posts tagged '${tag}'.`}>
  <h1 style="text-transform:capitalize;">Tag: {tag}</h1>
  {posts.length === 0 && <p class="muted">No posts yet.</p>}
  {posts.length > 0 && (
    <ul style="list-style:none;padding:0;display:grid;gap:var(--space-6);margin:var(--space-6)_0;">
      {posts.map(post => (
        <li style="border:1px solid var(--color-border);padding:var(--space-5);border-radius:var(--radius-md);background:var(--color-surface-subtle);">
          <h2 style="margin-top:0;font-size:var(--font-size-lg);"><a href={`/blog/${post.slug}/`}>{post.data.title}</a></h2>
          <p style="margin:0 0 var(--space-3);">{post.data.description}</p>
          <p class="muted" style="font-size:var(--font-size-xs);margin:0;"><time datetime={post.data.publishDate.toISOString()}>{post.data.publishDate.toLocaleDateString(undefined,{dateStyle:'medium'})}</time></p>
        </li>
      ))}
    </ul>
  )}
  <p><a href="/blog">‚Üê Back to all posts</a></p>
</Layout>
