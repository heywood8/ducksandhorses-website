---
import { getCollection } from 'astro:content';

import Layout from '../../layouts/Layout.astro';

const allPosts = await getCollection('blog');
// Filter out drafts & sort newest first
const posts = allPosts.filter(p => !p.data.draft).sort((a,b) => b.data.publishDate.getTime() - a.data.publishDate.getTime());
const base = import.meta.env.BASE_URL.replace(/\/$/, '');
---
<Layout title="Blog" description="Articles and short insights on therapy, mental health literacy, and evidence-based practices.">
  <h1>Blog</h1>
  <p class="muted" style="max-width:60ch;">Short, reader-friendly posts demystifying therapy and supporting psychologically flexible living.</p>
  <ul style="list-style:none;padding:0;margin:var(--space-6)_0;display:grid;gap:var(--space-6);">
    {posts.map(post => {
      const { title, description, publishDate, tags } = post.data;
      return (
        <li style="border:1px solid var(--color-border);padding:var(--space-5);border-radius:var(--radius-md);background:var(--color-surface-subtle);">
          <h2 style="margin-top:0;font-size:var(--font-size-xl);"><a href={`${base}/blog/${post.slug}/`}>{title}</a></h2>
          <p style="margin:0 0 var(--space-3);">{description}</p>
          <p class="muted" style="font-size:var(--font-size-xs);margin:0 0 var(--space-3);"><time datetime={publishDate.toISOString()}>{publishDate.toLocaleDateString(undefined,{dateStyle:'medium'})}</time></p>
          {tags.length > 0 && (
            <ul style="display:flex;gap:var(--space-2);flex-wrap:wrap;list-style:none;padding:0;margin:0;">
              {tags.map(t => <li style="background:var(--color-surface);padding:2px 6px;border-radius:var(--radius-sm);font-size:var(--font-size-xs);"><a href={`${base}/blog/tags/${encodeURIComponent(t.toLowerCase())}`}>{t}</a></li>)}
            </ul>
          )}
        </li>
      );
    })}
  </ul>
</Layout>
